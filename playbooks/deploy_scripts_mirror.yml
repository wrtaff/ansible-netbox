# ==============================================================================
# Filename:       playbooks/deploy_scripts_mirror.yml
# Version:        1.3
# Author:         Gemini CLI
# Last Modified:  2026-02-18
# Context:        http://trac.home.arpa/ticket/3085
#
# Purpose:
#    Mirrors the local scripts/ directory and requirements.txt to a remote 
#    host (limbo-bd). Provides read-only access to the project's utility and 
#    automation scripts.
#
#    Configuration:
#      - Local Source:  ./scripts/
#      - Remote Dest:   /home/will/gemini_projects/scripts/
#
#    Prerequisites:
#      - 'rsync' must be installed on both the controller and the target host.
#      - vault.yml (for encrypted variables if needed)
#
# Usage:
#      ansible-playbook -i inventory.ini playbooks/deploy_scripts_mirror.yml
#
# Revision History:
#    v1.3 (2026-02-18) - Added synchronization of requirements.txt
# ==============================================================================


- name: Mirror Scripts to Remote Hosts
  hosts: limbo-bd
  gather_facts: false
  become: false  # rsync to user home doesn't need root
  vars_files: [../vault.yml]
  
  tasks:
    - name: Ensure target directory exists
      ansible.builtin.file:
        path: /home/will/gemini_projects
        state: directory
        mode: '0755'

    - name: Synchronize scripts directory
      ansible.posix.synchronize:
        src: "{{ playbook_dir }}/../scripts/"
        dest: /home/will/gemini_projects/scripts/
        archive: yes
        delete: yes  # Mirroring: delete files on dest that aren't on source
        recursive: yes
      delegate_to: localhost

    - name: Synchronize mcp-servers directory
      ansible.posix.synchronize:
        src: "{{ playbook_dir }}/../mcp-servers/"
        dest: /home/will/gemini_projects/mcp-servers/
        archive: yes
        delete: yes  # Mirroring: delete files on dest that aren't on source
        recursive: yes
      delegate_to: localhost

    - name: Copy requirements.txt
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../requirements.txt"
        dest: /home/will/gemini_projects/requirements.txt
        mode: '0644'

    - name: Copy vault.yml
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../vault.yml"
        dest: /home/will/gemini_projects/vault.yml
        mode: '0644'