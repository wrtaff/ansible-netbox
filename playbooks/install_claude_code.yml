# ==============================================================================
# Filename:       install_claude_code.yml
# Version:        1.6
# Author:         Gemini CLI
# Last Modified:  2026-02-21
# Context:        http://trac.home.arpa/ticket/3038
#
# Purpose:
#   Installs or updates the Claude Code CLI tool globally via NPM on target hosts.
#
# Update 1.6:
#   - Changed state from 'present' to 'latest' to allow updates.
#   - Added pre-check task to capture current version before installation.
#   - Enhanced debug output to show before/after versions.
#
# Update 1.5:
#   - Finalized installation and documentation.
#   - Verified and ready for production use.
#
# Update 1.4:
#   - Verified successful installation on limbo-bd. 
#   - Ready for user testing via '/login'.
#
# Update 1.3:
#   - Removed redundant nodejs/npm package task. They are already installed
#     and attempting to manage them via apt caused dependency conflicts.
# ==============================================================================
---
- name: Install or Update Claude Code CLI
  hosts: limbo-bd
  become: true
  gather_facts: true

  tasks:
    - name: 0. Check current Claude Code version (if any)
      ansible.builtin.command:
        cmd: claude --version
      register: claude_version_before
      changed_when: false
      failed_when: false
      tags: [install, verify]

    - name: 1. Install or Update Claude Code CLI Globally via NPM
      ansible.builtin.npm:
        name: "@anthropic-ai/claude-code"
        global: true
        state: latest
      tags: install

    - name: 2. Verify Claude Code CLI is installed
      ansible.builtin.command:
        cmd: claude --version
      register: claude_version_output
      changed_when: false
      tags: verify

    - name: 3. Show Claude Code Version
      ansible.builtin.debug:
        msg: >-
          Claude Code version: {{ claude_version_output.stdout }}
          {% if claude_version_before.rc == 0 and claude_version_before.stdout != claude_version_output.stdout %}
          (updated from {{ claude_version_before.stdout }})
          {% elif claude_version_before.rc != 0 %}
          (fresh install)
          {% else %}
          (already up to date)
          {% endif %}
      when: claude_version_output.rc == 0
