# ==============================================================================
# Filename:       roles/system_common/tasks/main.yml
# Version:        1.7
# Author:         Gemini CLI
# Last Modified:  2026-02-27
# Context:        http://trac.home.arpa/ticket/3032
#
# Revision History:
#     1.0 - Initial version.
#     1.1 - Added systemd-networkd-wait-online override with --any flag.
#     1.2 - Switched to disabling redundant network managers.
#     1.3 - Re-implemented wait-online fix using override with --any flag. 
#     1.4 - Added --interface=eth0 to override.
#     1.5 - Set --operational-state=routable.
#     1.6 - Switched to dummy /bin/true override.
#     1.7 - Diverted /lib/systemd/systemd-networkd-wait-online binary to 
#           /bin/true via dpkg-divert for definitive fix.
#
# Purpose:
#     Baseline configuration tasks for all Debian/Ubuntu servers.
# ==============================================================================
---
- name: Update apt package cache and upgrade all packages
  ansible.builtin.apt:
    update_cache: yes
    upgrade: dist
    cache_valid_time: 3600

- name: Ensure common utility packages are installed
  ansible.builtin.apt:
    name:
      - curl
      - htop
      - git
      - vim
    state: present

- name: Install QEMU Guest Agent for Proxmox VMs
  ansible.builtin.apt:
    name: qemu-guest-agent
    state: present
  when: ansible_virtualization_type == "kvm"

- name: Set system timezone from group_vars
  become: yes
  community.general.timezone:
    name: "{{ system_timezone }}"
  notify: Restart cron

- name: Set vim.tiny as the default system editor
  community.general.alternatives:
    name: editor
    path: /usr/bin/vim.tiny

- name: Enable vim showmode for all users
  become: yes
  ansible.builtin.lineinfile:
    path: /etc/vim/vimrc.local
    line: "set showmode"
    create: yes
    mode: '0644'

# --- NEW TASKS FOR REBOOT MANAGEMENT ---
- name: Check if a reboot is required
  ansible.builtin.stat:
    path: /var/run/reboot-required
  register: reboot_required_file

- name: Reboot the server if required
  ansible.builtin.reboot:
    msg: "Reboot initiated by Ansible due to kernel updates"
  when: reboot_required_file.stat.exists

# --- SYSTEMIC NETWORK WAIT FIX (REF: #3032) ---
- name: Check if ifupdown is the primary network manager
  ansible.builtin.stat:
    path: /etc/network/interfaces
  register: ifupdown_config

- name: Detect active network managers
  ansible.builtin.service_facts:

- name: Check if systemd-networkd-wait-online diversion exists
  ansible.builtin.shell: dpkg-divert --list /lib/systemd/systemd-networkd-wait-online
  register: diversion_check
  changed_when: false
  when: ifupdown_config.stat.exists

- name: Divert systemd-networkd-wait-online binary to prevent apt hangs
  ansible.builtin.shell: |
    dpkg-divert --add --rename --divert /lib/systemd/systemd-networkd-wait-online.real /lib/systemd/systemd-networkd-wait-online
    ln -sf /bin/true /lib/systemd/systemd-networkd-wait-online
  when: 
    - ifupdown_config.stat.exists
    - diversion_check.stdout == ""

- name: Disable redundant network managers to prevent 'wait-online' hangs
  ansible.builtin.service:
    name: "{{ item }}"
    state: stopped
    enabled: no
  loop:
    - systemd-networkd
    - systemd-networkd-wait-online
    - NetworkManager
    - NetworkManager-wait-online
  when: 
    - ifupdown_config.stat.exists
    - ansible_facts.services[item + '.service'] is defined
    - ansible_facts.services[item + '.service'].status != 'not-found'
    - ansible_facts.services[item + '.service'].state != 'masked'

- name: Ensure redundant override directory is removed
  ansible.builtin.file:
    path: /etc/systemd/system/systemd-networkd-wait-online.service.d
    state: absent
  notify: Reload systemd
