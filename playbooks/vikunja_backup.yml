---
# ==============================================================================
# Playbook Name: vikunja_backup.yml
# Absolute Path: /opt/netbox/ansible-netbox/playbooks/vikunja_backup.yml
# Purpose:       Automates the backup of the Vikunja application on vik-01.
#                1. Stops the Vikunja service to ensure database consistency.
#                2. Archives the data directory (/var/lib/vikunja).
#                3. Starts the Vikunja service.
#                4. Pulls the archive to the Ansible Controller.
#                5. Pushes the backup via SCP to TrueNAS storage.
#                6. Cleans up local and remote temporary files.
#
# Prerequisites:
#   - SSH Key (/root/.ssh/vikunja_backup_key) authorized on vik-01 and TrueNAS.
#   - Vikunja installed using the binary method (service: vikunja).
#   - 'community.general' collection.
#
# Usage:
#   ansible-playbook playbooks/vikunja_backup.yml -i inventory.ini --limit vik-01 --private-key /root/.ssh/vikunja_backup_key
#
# Trac Ticket:   http://trac.home.arpa/ticket/2781
# ==============================================================================

- name: Back up Vikunja on vik-01 and scp to TrueNAS
  hosts: vik-01
  become: yes
  gather_facts: no

  vars:
    # Source data directory on vik-01
    backup_src_dir: "/var/lib/vikunja"
    # Temporary directory for creating the archive
    remote_temp_path: "/tmp"
    
    # Temporary path on the ansible controller (netbox1)
    controller_temp_path: "/tmp"

    # SCP Destination on TrueNAS
    scp_user: "root"
    scp_host: "truenas.home.arpa"
    scp_dest_path: "/mnt/tank22/smb-share/smb-home/Backups/Vikunja/"
    
    # SSH Key to use for the SCP transfer
    ssh_key_path: "/root/.ssh/vikunja_backup_key"

  tasks:
    - name: 0. Generate timestamp
      ansible.builtin.set_fact:
        timestamp: "{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"

    - name: 0b. Set backup filename
      ansible.builtin.set_fact:
        backup_filename: "vikunja-backup-{{ timestamp }}.tar.gz"

    # --- Phase 1: Creation on vik-01 ---
    - name: 1. Stop Vikunja service
      ansible.builtin.systemd:
        name: vikunja
        state: stopped

    - name: 2. Create backup archive of /var/lib/vikunja
      community.general.archive:
        path: "{{ backup_src_dir }}"
        dest: "{{ remote_temp_path }}/{{ backup_filename }}"
        format: gz
        owner: root
        group: root
        mode: '0600'
      register: archive_result

    - name: 3. Start Vikunja service
      ansible.builtin.systemd:
        name: vikunja
        state: started

    # --- Phase 2: Transfer to Controller (Pull) ---
    - name: 4. Fetch backup file from vik-01 to controller
      ansible.builtin.fetch:
        src: "{{ remote_temp_path }}/{{ backup_filename }}"
        dest: "{{ controller_temp_path }}/"
        flat: yes
      when: archive_result.changed

    # --- Phase 3: Transfer to TrueNAS (Push) ---
    - name: 5. Push backup file from controller to TrueNAS
      delegate_to: localhost
      become: no
      ansible.builtin.shell: |
        scp -i "{{ ssh_key_path }}" \
            -o StrictHostKeyChecking=no \
            "{{ controller_temp_path }}/{{ backup_filename }}" \
            "{{ scp_user }}@{{ scp_host }}:{{ scp_dest_path }}"
      when: archive_result.changed
      changed_when: true

    # --- Phase 4: Cleanup ---
    - name: 6. Clean up local file from controller
      delegate_to: localhost
      become: no
      ansible.builtin.file:
        path: "{{ controller_temp_path }}/{{ backup_filename }}"
        state: absent

    - name: 7. Clean up remote backup file from vik-01
      ansible.builtin.file:
        path: "{{ remote_temp_path }}/{{ backup_filename }}"
        state: absent

