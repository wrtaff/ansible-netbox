# ------------------------------------------------------------------------------
# Playbook: rsyslog-Graylog-config.yml
# Path: /opt/netbox/ansible-netbox/playbooks/rsyslog-Graylog-config.yml
# Trac Ticket: #2883
# Wiki Page: http://192.168.0.99/mediawiki/index.php/Playbooks/rsyslog-Graylog-config.yml
#
# Purpose:
#   Configures rsyslog to ship system logs to the central Graylog server.
#
# Usage:
#   ansible-playbook -i inventory.ini playbooks/rsyslog-Graylog-config.yml --limit <host>
# ------------------------------------------------------------------------------
# ==============================================================================
# Absolute Path: /opt/netbox/ansible-netbox/playbooks/rsyslog-Graylog-config.yml
# Purpose:       This Ansible playbook configures rsyslog on target hosts to
#                forward all logs to a central Graylog server and tags the
#                host with 'graylog' in NetBox.
# Version:       1.2.0 (Last Modified: 2026-02-13)
# Prerequisites:
#   - Ansible control node with Ansible installed.
#   - SSH access and sudo/root privileges ('become: yes') on target hosts.
#   - A running Graylog server accessible at the IP address specified in
#     the 'graylog_server_ip' variable (default: 192.168.0.104).
#   - Network connectivity from target hosts to the Graylog server on the
#     specified port and protocol (default: UDP 1514).
#   - Target systems must be Debian-based to use the 'ansible.builtin.apt' module.
#   - NetBox environment variables (NETBOX_URL, NETBOX_TOKEN) must be set on the
#     control node for NetBox integration.
# ==============================================================================
---
- name: Configure rsyslog and update NetBox
  hosts: all # You can change this to a specific group of hosts from your inventory
  become: yes # This tells Ansible to use sudo to run the tasks

  # --- Variables ---
  # Define your Graylog server details here to easily manage them.
  vars:
    graylog_server_ip: 192.168.0.104 # <-- IMPORTANT: Change this to your Graylog server's IP address
    graylog_port: 1514
    # Use '@' for UDP (default, less reliable) or '@@' for TCP (more reliable)
    graylog_protocol: "@"
    netbox_url: "http://netbox1.home.arpa"
    netbox_token: "{{ lookup('env', 'NETBOX_TOKEN') }}"

  # --- Tasks ---
  # The sequence of operations Ansible will perform on each host.
  tasks:
    - name: Ensure rsyslog is installed
      ansible.builtin.apt:
        name: rsyslog
        state: present
        update_cache: yes # Good practice to run 'apt update' before installing

    - name: Ensure rsyslog service is enabled and started
      ansible.builtin.service:
        name: rsyslog
        state: started
        enabled: yes

    - name: Ensure the rsyslog.d directory exists
      ansible.builtin.file:
        path: /etc/rsyslog.d
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Create rsyslog configuration file for Graylog
      ansible.builtin.copy:
        # The destination path for the new configuration file.
        dest: /etc/rsyslog.d/90-graylog.conf
        # The content of the configuration file. It uses the variables defined above.
        # This line configures rsyslog to forward all logs (*.*) to your Graylog server.
        content: "*.* {{ graylog_protocol }}{{ graylog_server_ip }}:{{ graylog_port }}\n"
        owner: root
        group: root
        mode: '0644'
      # This 'notify' keyword triggers the handler below, but only if this task makes a change.
      notify:
        - Restart rsyslog

    - name: Tag Virtual Machine in NetBox with 'graylogger'
      netbox.netbox.netbox_virtual_machine:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        data:
          name: "{{ inventory_hostname }}"
          tags:
            - slug: graylogger
        state: present
      delegate_to: localhost
      when: ansible_virtualization_role is defined and ansible_virtualization_role == 'guest'
      ignore_errors: yes

    - name: Tag Physical Device in NetBox with 'graylogger'
      netbox.netbox.netbox_device:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        data:
          name: "{{ inventory_hostname }}"
          tags:
            - slug: graylogger
        state: present
      delegate_to: localhost
      when: ansible_virtualization_role is not defined or ansible_virtualization_role != 'guest'
      ignore_errors: yes

  # --- Handlers ---
  # Handlers are special tasks that only run when notified by another task.
  # This is the best practice for restarting services.
  handlers:
    - name: Restart rsyslog
      # The 'listen' keyword connects this handler to the 'notify' call above.
      listen: "Restart rsyslog"
      # Using the generic 'service' module for better compatibility across different Linux versions.
      ansible.builtin.service:
        name: rsyslog
        state: restarted
