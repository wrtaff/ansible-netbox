# Playbook: /opt/netbox/ansible-netbox/playbooks/installGlancesDebian.yaml
# Use Case: Provides a lightweight, web-based system resource monitor for hosts
#          to be integrated with Home Assistant via the Glances integration.
# Installation Method: Automated script via 'curl https://bit.ly/glances | /bin/bash'
# Prerequisites: 
#   - Debian-based Linux distribution
#   - Internet connectivity (to fetch installation script)
#   - Python 3 environment
# Configuration:
#   - Systemd Service: /etc/systemd/system/glances.service
#   - Port: 61208/TCP
#   - Default Credentials: user 'glances', password defaults to 'glances' (or $GLANCES_PASSWORD)
# Usage:
#   ansible-playbook -i inventory.ini playbooks/installGlancesDebian.yaml -l <host>
# Removal Instructions:
#   - systemctl stop glances
#   - systemctl disable glances
#   - rm /etc/systemd/system/glances.service
#   - pip3 uninstall glances (or manual cleanup of the bin/bash script artifacts)
# Links:
#   - Trac Ticket: http://trac.home.arpa/ticket/2500
#   - NetBox Service (pve2): http://netbox1.home.arpa/ipam/services/60/
#   - NetBox Service (proxmox1): http://netbox1.home.arpa/ipam/services/61/

- name: Install and Configure Glances
  hosts: all  # Adjust to your target hosts
  become: true
  vars_files:
    - ../vault.yml
  tasks:
    - name: Download and Install Glances
      shell: curl -L https://bit.ly/glances | /bin/bash
      register: glances_install_result
      changed_when: "'Installation successful' in glances_install_result.stdout"

    - name: Wait for Glances Installation to Complete
      pause:
        minutes: 2

    - name: Start Glances with Web Interface and Authentication
      command: glances -w --username your_username --password your_password
      async: 3600  # Run in background for up to 1 hour
      poll: 0
      register: glances_start_result
      ignore_errors: true # so that ansible doesn't fail if glances is already running

    - name: Check Glances start result.
      debug:
        var: glances_start_result
      when: glances_start_result.rc != 0

  vars:
    your_username: "glances" 
    your_password: "{{ vault_glances_password | default(lookup('env', 'GLANCES_PASSWORD')) | default('glances', true) }}" 
