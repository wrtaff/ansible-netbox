---
- hosts: debian
  gather_facts: no
  become: no

  vars:
    admin_user: will

  tasks:
    - name: 1. Run apt-get update using raw command
      ansible.builtin.raw: apt-get update -y
      changed_when: false
      failed_when: false

    - name: 2. Install sudo and python3 using raw command
      ansible.builtin.raw: apt-get install -y sudo python3
      changed_when: false

    - name: 3. Gather facts now that python is installed
      ansible.builtin.setup:

    - name: 4. Create the '{{ admin_user }}' admin user
      ansible.builtin.user:
        name: "{{ admin_user }}"
        state: present
        shell: /bin/bash
        create_home: yes

    - name: 5. Grant the admin user passwordless sudo privileges
      ansible.builtin.copy:
        dest: "/etc/sudoers.d/{{ admin_user }}"
        content: "{{ admin_user }} ALL=(ALL) NOPASSWD: ALL"
        mode: '0440'
        validate: 'visudo -cf %s'

    - name: 6. Deploy SSH key for the admin user
      ansible.posix.authorized_key:
        user: "{{ admin_user }}"
        state: present
        key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
