# ==============================================================================
# Filename:       playbooks/update_tailscale_cert_YNH.yml
# Version:        1.1
# Author:         Gemini CLI
# Last Modified:  2026-02-05
# Context:        http://trac.home.arpa/ticket/3033
#
# Purpose:
#     Updates Tailscale TLS certificates for YunoHost servers and notifies relay.
#
# Revision History:
#     1.1 - Added success notification to central mail relay and delegated to localhost.
#
# NOTES:
#     Always bump versions when making changes and annotate them here.
# ==============================================================================
---
- name: Update Tailscale TLS Certificate for YunoHost
  hosts: yunohost_servers
  become: yes
  vars:
    # Define your domain and certificate path here for easy updates.
    domain_name: "ynh2.van-bee.ts.net"
    cert_dir: "/etc/yunohost/certs/{{ domain_name }}"
    backup_dir: "{{ cert_dir }}/self-signed"

  tasks:
    - name: Ensure backup directory exists
      ansible.builtin.file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'

    - name: Find existing certificate files (.pem)
      ansible.builtin.find:
        paths: "{{ cert_dir }}"
        patterns: "*.pem"
        use_regex: no
        file_type: file
      register: old_certs

    - name: Back up old certificate files if they exist
      ansible.builtin.command:
        cmd: "mv {{ item.path }} {{ backup_dir }}/"
      loop: "{{ old_certs.files }}"
      when: old_certs.files | length > 0

    - name: Generate new Tailscale certificate
      ansible.builtin.command:
        cmd: "tailscale cert --cert-file crt.pem --key-file key.pem {{ domain_name }}"
        chdir: "{{ cert_dir }}"
        creates: "{{ cert_dir }}/crt.pem"
      register: cert_generation
      changed_when: "'Wrote public cert' in cert_generation.stdout"
      notify: Reload Nginx

    - name: Set correct permissions on certificate files
      ansible.builtin.file:
        path: "{{ cert_dir }}/{{ item }}"
        owner: root
        group: metronome
        mode: '0640'
      loop:
        - crt.pem
        - key.pem
      notify: Reload Nginx

    - name: Flush handlers to ensure Nginx is reloaded before notification
      ansible.builtin.meta: flush_handlers

    - name: Notify central mail relay of success
      ansible.builtin.shell: |
        echo "Tailscale TLS certificate for {{ domain_name }} has been successfully updated on {{ inventory_hostname }}. Nginx has been reloaded." | mail -s "Tailscale Cert Update Success: {{ domain_name }}" root
      delegate_to: localhost
      when: cert_generation.changed

  handlers:
    - name: Reload Nginx
      listen: "Reload Nginx"
      ansible.builtin.command:
        cmd: "yunohost service reload nginx"
      # We don't want the play to fail if nginx isn't running for some reason
      ignore_errors: true