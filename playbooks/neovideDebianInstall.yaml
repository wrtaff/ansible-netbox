---
# Playbook: install_neovide.yml
# Author:   Your Name
# Date:     2025-09-04
# Version:  2.1
# Description: This playbook installs and configures Neovim (from PPA) and Neovide.
#              It uses a robust find-and-copy method for the Neovide binary.

- name: Install and Configure Neovim and Neovide
  hosts: all
  become: yes
  vars:
    # Set the user for whom the nvim config will be deployed.
    target_user: will

  tasks:
    # --- System Prerequisites ---
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600
      tags:
        - packages

    - name: Install prerequisites
      ansible.builtin.apt:
        name:
          - software-properties-common
          - curl
          - git  # Added for plugin management
          - libfontconfig1
          - libxkbcommon-x11-0
        state: present
      tags:
        - packages

    # --- Neovim Installation ---
    - name: Add Neovim unstable PPA
      ansible.builtin.apt_repository:
        repo: ppa:neovim-ppa/unstable
        state: present
      tags:
        - install
        - neovim

    - name: Install latest Neovim from PPA
      ansible.builtin.apt:
        name: neovim
        state: latest
        update_cache: yes
      tags:
        - install
        - neovim

    # --- Neovide Installation ---
    - name: Find the latest Neovide release info
      ansible.builtin.uri:
        url: "https://api.github.com/repos/neovide/neovide/releases/latest"
        method: GET
        return_content: yes
        headers:
          Accept: "application/vnd.github.v3+json"
      register: latest_neovide_release
      check_mode: no

    - name: Set the download URL for the .tar.gz package
      ansible.builtin.set_fact:
        neovide_tar_url: "{{ latest_neovide_release.json.assets | selectattr('name', 'match', '.*neovide-linux-x86_64\\.tar\\.gz$') | map(attribute='browser_download_url') | first }}"
      when: latest_neovide_release.json.assets is defined

    - name: Fail if .tar.gz release asset is not found
      ansible.builtin.fail:
        msg: "Could not find a 'neovide-linux-x86_64.tar.gz' asset in the latest Neovide release."
      when: neovide_tar_url is not defined or neovide_tar_url == ""

    - name: Create temporary extraction directory for Neovide
      ansible.builtin.file:
        path: "/tmp/neovide_extracted"
        state: directory
        mode: '0755'
      tags:
        - install
        - neovide

    - name: Download and unarchive the latest Neovide package
      ansible.builtin.unarchive:
        src: "{{ neovide_tar_url }}"
        dest: "/tmp/neovide_extracted"
        remote_src: yes
      tags:
        - install
        - neovide

    - name: Find the extracted Neovide executable
      ansible.builtin.find:
        paths: "/tmp/neovide_extracted"
        patterns: "neovide"
        file_type: file
        recurse: yes
      register: neovide_executable_path
      tags:
        - install
        - neovide

    - name: Fail if Neovide executable is not found in archive
      ansible.builtin.fail:
        msg: "Could not find the 'neovide' executable within the extracted archive."
      when: neovide_executable_path.matched == 0
      tags:
        - install
        - neovide

    - name: Install Neovide binary to /usr/local/bin
      ansible.builtin.copy:
        src: "{{ neovide_executable_path.files[0].path }}"
        dest: "/usr/local/bin/neovide"
        remote_src: yes
        mode: '0755'
        owner: root
        group: root
      tags:
        - install
        - neovide

    # --- Neovim User Configuration ---
    - name: Create Neovim config directory for user
      ansible.builtin.file:
        path: "/home/{{ target_user }}/.config/nvim"
        state: directory
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0755'
      tags:
        - config

    - name: Deploy Neovim configuration for syntax highlighting
      ansible.builtin.copy:
        dest: "/home/{{ target_user }}/.config/nvim/init.lua"
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0644'
        content: |
          -- Auto-install lazy.nvim if not already installed
          local lazypath = vim.fn.stdpath("data") .. "/lazy/lazy.nvim"
          if not vim.loop.fs_stat(lazypath) then
            vim.fn.system({
              "git",
              "clone",
              "--filter=blob:none",
              "https://github.com/folke/lazy.nvim.git",
              "--branch=stable", -- latest stable release
              lazypath,
            })
          end
          vim.opt.rtp:prepend(lazypath)

          -- Setup plugins
          require("lazy").setup({
            -- 1. The main Treesitter plugin
            {
              "nvim-treesitter/nvim-treesitter",
              build = ":TSUpdate", -- Keeps parsers updated
              config = function()
                require("nvim-treesitter.configs").setup({
                  -- A list of parser names, or "all"
                  ensure_installed = { "c", "lua", "vim", "vimdoc", "query", "python", "bash", "yaml" },
                  sync_install = false,
                  auto_install = true,
                  highlight = {
                    enable = true, -- Enable syntax highlighting
                  },
                })
              end,
            },

            -- 2. A nice colorscheme that supports Treesitter
            {
              "catppuccin/nvim",
              name = "catppuccin",
              priority = 1000, -- Make sure it loads first
              config = function()
                -- Load the colorscheme
                vim.cmd.colorscheme "catppuccin"
              end,
            },
          })
      tags:
        - config

    # --- Cleanup ---
    - name: Ensure old manual nvim install is removed to avoid conflicts
      ansible.builtin.file:
        path: /usr/local/bin/nvim
        state: absent
      tags:
        - cleanup

    - name: Clean up temporary Neovide files
      ansible.builtin.file:
        path: "/tmp/neovide_extracted"
        state: absent
      tags:
        - cleanup


