# ------------------------------------------------------------------------------
# Playbook: wazuh-agent.yml
# Path: /opt/netbox/ansible-netbox/playbooks/wazuh-agent.yml
# Trac Ticket: #2884
# Wiki Page: http://192.168.0.99/mediawiki/index.php/Playbooks/wazuh-agent.yml
#
# Purpose:
#   Deploys and configures the Wazuh security agent.
#
# Usage:
#   ansible-playbook -i inventory.ini playbooks/wazuh-agent.yml --limit <host>
# ------------------------------------------------------------------------------
# ==============================================================================
# Absolute Path: /opt/netbox/ansible-netbox/playbooks/wazuh-agent.yml
# Purpose:       This Ansible playbook installs and configures the Wazuh agent
#                on target hosts and tags the host with 'wazuh-agent' in NetBox.
# Version:       1.2.0 (Last Modified: 2026-01-24)
# Prerequisites:
#   - Ansible control node with Ansible installed.
#   - Python 3 on the control node.
#   - SSH access to target hosts in the 'wazuh_agents' group.
#   - Sudo/root privileges on target hosts ('become: yes').
#   - Network connectivity to the Wazuh manager at 192.168.0.11 on port 1514 (TCP).
#   - The 'ansible-wazuh-agent' role must be available in the configured
#     Ansible roles path (roles_path).
#   - Target systems must be Debian-based (inferred from 'apt' repo config).
#   - NetBox environment variables (NETBOX_URL, NETBOX_TOKEN) must be set on the
#     control node for NetBox integration.
#
# Recent Changes:
#   - Added support for tagging both Virtual Machines and Physical Devices in
#     NetBox with the 'wazuh-agent' tag upon successful installation.
#
# References:
#   - http://trac.home.arpa/ticket/2440 ("Ansible playbook for Wazuh Deployment
#     'wazuh-agent.yml' needs action")
#   - http://trac.home.arpa/ticket/2404#comment:17
# ==============================================================================
- hosts: wazuh_agents
  become: yes

  vars:
    netbox_url: "http://netbox1.home.arpa"
    netbox_token: "{{ lookup('env', 'NETBOX_TOKEN') }}"
    wazuh_agent_config:
      repo:
        apt: "deb [signed-by=/usr/share/keyrings/wazuh.gpg] https://packages.wazuh.com/4.x/apt/ stable main"

    wazuh_managers:
      - address: 192.168.0.11
        port: 1514
        protocol: tcp
        api_port: 55000
        api_proto: 'https'
        api_user: wazuh
        max_retries: 5
        retry_interval: 5
    wazuh_agent_authd:
      enable: true

  roles:
    - ansible-wazuh-agent # Corrected role name

  post_tasks:
    - name: Tag Virtual Machine in NetBox with 'wazuh-agent'
      netbox.netbox.netbox_virtual_machine:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        data:
          name: "{{ inventory_hostname }}"
          tags:
            - slug: wazuh-agent
        state: present
      delegate_to: localhost
      when: ansible_virtualization_role is defined and ansible_virtualization_role == 'guest'
      ignore_errors: yes

    - name: Tag Physical Device in NetBox with 'wazuh-agent'
      netbox.netbox.netbox_device:
        netbox_url: "{{ netbox_url }}"
        netbox_token: "{{ netbox_token }}"
        data:
          name: "{{ inventory_hostname }}"
          tags:
            - slug: wazuh-agent
        state: present
      delegate_to: localhost
      when: ansible_virtualization_role is not defined or ansible_virtualization_role != 'guest'
      ignore_errors: yes